{% extends 'base.html' %}
{% load static %}

{% block title %}Coupon Management - NutriHarvest{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-4 fw-bold">Coupon Management</h1>
            {% if can_add %}
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponModal">
                <i data-lucide="plus" class="me-2"></i>Add New Coupon
            </button>
            {% endif %}
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Application</th>
                                <th>Validity</th>
                                <th>Uses</th>
                                <th>Status</th>
                                {% if can_edit or can_delete %}
                                <th>Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for coupon in coupons %}
                            <tr>
                                <td>
                                    <strong>{{ coupon.code }}</strong>
                                </td>
                                <td>
                                    {{ coupon.get_coupon_type_display }}
                                </td>
                                <td>
                                    {% if coupon.coupon_type == 'percentage' %}
                                        {{ coupon.discount_value }}%
                                    {% else %}
                                        ${{ coupon.discount_value }}
                                    {% endif %}
                                </td>
                                <td>
                                    {{ coupon.get_discount_application_display }}
                                    {% if coupon.category %}
                                        <br><small class="text-muted">{{ coupon.category.name }}</small>
                                    {% endif %}
                                    {% if coupon.product %}
                                        <br><small class="text-muted">{{ coupon.product.name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        From: {{ coupon.valid_from|date:"M d, Y" }}<br>
                                        {% if coupon.valid_to %}
                                        To: {{ coupon.valid_to|date:"M d, Y" }}
                                        {% else %}
                                        No expiry
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {{ coupon.used_count }}{% if coupon.max_uses %}/{{ coupon.max_uses }}{% endif %}
                                </td>
                                <td>
                                    {% if coupon.is_active and coupon.is_valid %}
                                        <span class="badge bg-success">Active</span>
                                    {% elif coupon.is_active %}
                                        <span class="badge bg-warning text-dark">Inactive</span>
                                    {% else %}
                                        <span class="badge bg-danger">Expired</span>
                                    {% endif %}
                                </td>
                                {% if can_edit or can_delete %}
                                <td>
                                    <div class="btn-group" role="group">
                                        {% if can_edit %}
                                        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editCouponModal{{ coupon.id }}">
                                            <i data-lucide="edit" class="me-1"></i>Edit
                                        </a>
                                        {% endif %}
                                        {% if can_delete %}
                                        <a href="#" class="btn btn-sm btn-outline-danger">
                                            <i data-lucide="trash" class="me-1"></i>Delete
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center">No coupons found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="addCouponModalLabel">Add New Coupon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Coupon Code *</label>
                            <input type="text" class="form-control" name="code" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Coupon Type *</label>
                            <select class="form-select" name="coupon_type" required>
                                <option value="percentage">Percentage Discount</option>
                                <option value="fixed">Fixed Amount Discount</option>
                                <option value="free_shipping">Free Shipping</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Discount Value *</label>
                            <input type="number" class="form-control" name="discount_value" step="0.01" required>
                            <small class="text-muted">For percentage, enter value like 10 for 10%. For fixed amount, enter dollar amount.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Discount Application *</label>
                            <select class="form-select" name="discount_application">
                                <option value="cart">Entire Cart</option>
                                <option value="category">Specific Category</option>
                                <option value="product">Specific Product</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category (Optional)</label>
                            <select class="form-select" name="category">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product (Optional)</label>
                            <select class="form-select" name="product">
                                <option value="">Select Product</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Maximum Uses</label>
                            <input type="number" class="form-control" name="max_uses" min="1">
                            <small class="text-muted">Leave blank for unlimited uses</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Uses Per User</label>
                            <input type="number" class="form-control" name="max_uses_per_user" min="1" value="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Minimum Purchase Amount</label>
                            <input type="number" class="form-control" name="min_purchase_amount" step="0.01">
                            <small class="text-muted">Minimum cart amount required to use this coupon</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valid To</label>
                            <input type="date" class="form-control" name="valid_to">
                            <small class="text-muted">Leave blank for no expiry</small>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                                <label class="form-check-label" for="isActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Coupon</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Coupon Modals (one for each coupon) -->
{% for coupon in coupons %}
<div class="modal fade" id="editCouponModal{{ coupon.id }}" tabindex="-1" aria-labelledby="editCouponModalLabel{{ coupon.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="coupon_id" value="{{ coupon.id }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCouponModalLabel{{ coupon.id }}">Edit Coupon: {{ coupon.code }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Coupon Code *</label>
                            <input type="text" class="form-control" name="code" value="{{ coupon.code }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Coupon Type *</label>
                            <select class="form-select" name="coupon_type" required>
                                <option value="percentage" {% if coupon.coupon_type == 'percentage' %}selected{% endif %}>Percentage Discount</option>
                                <option value="fixed" {% if coupon.coupon_type == 'fixed' %}selected{% endif %}>Fixed Amount Discount</option>
                                <option value="free_shipping" {% if coupon.coupon_type == 'free_shipping' %}selected{% endif %}>Free Shipping</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Discount Value *</label>
                            <input type="number" class="form-control" name="discount_value" step="0.01" value="{{ coupon.discount_value }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Discount Application *</label>
                            <select class="form-select" name="discount_application">
                                <option value="cart" {% if coupon.discount_application == 'cart' %}selected{% endif %}>Entire Cart</option>
                                <option value="category" {% if coupon.discount_application == 'category' %}selected{% endif %}>Specific Category</option>
                                <option value="product" {% if coupon.discount_application == 'product' %}selected{% endif %}>Specific Product</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category (Optional)</label>
                            <select class="form-select" name="category">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if coupon.category and coupon.category.id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product (Optional)</label>
                            <select class="form-select" name="product">
                                <option value="">Select Product</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" {% if coupon.product and coupon.product.id == product.id %}selected{% endif %}>{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Maximum Uses</label>
                            <input type="number" class="form-control" name="max_uses" min="1" value="{{ coupon.max_uses|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Uses Per User</label>
                            <input type="number" class="form-control" name="max_uses_per_user" min="1" value="{{ coupon.max_uses_per_user }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Minimum Purchase Amount</label>
                            <input type="number" class="form-control" name="min_purchase_amount" step="0.01" value="{{ coupon.min_purchase_amount|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Valid To</label>
                            <input type="date" class="form-control" name="valid_to" value="{{ coupon.valid_to|date:'Y-m-d'|default:'' }}">
                        </div>
                        <div class="col-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" id="isActive{{ coupon.id }}" {% if coupon.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="isActive{{ coupon.id }}">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Coupon</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
});
</script>
{% endblock %}