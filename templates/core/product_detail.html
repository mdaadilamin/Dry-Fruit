{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - NutriHarvest{% endblock %}
{% block meta_description %}{{ product.description|truncatewords:30 }} Buy premium {{ product.name }} at the best price. Fast delivery and quality guarantee.{% endblock %}
{% block meta_keywords %}{{ product.name }}, {{ product.category.name }}, dry fruits, nuts, organic, healthy snacks{% endblock %}

{% block og_title %}{{ product.name }} - NutriHarvest{% endblock %}
{% block og_description %}{{ product.description|truncatewords:30 }} Buy premium {{ product.name }} at the best price. Fast delivery and quality guarantee.{% endblock %}
{% block og_image %}{% if product.image %}{{ request.build_absolute_uri }}{{ product.image.url }}{% else %}https://images.pexels.com/photos/1295572/pexels-photo-1295572.jpeg?auto=compress&cs=tinysrgb&w=600{% endif %}{% endblock %}

{% block twitter_title %}{{ product.name }} - NutriHarvest{% endblock %}
{% block twitter_description %}{{ product.description|truncatewords:30 }} Buy premium {{ product.name }} at the best price. Fast delivery and quality guarantee.{% endblock %}
{% block twitter_image %}{% if product.image %}{{ request.build_absolute_uri }}{{ product.image.url }}{% else %}https://images.pexels.com/photos/1295572/pexels-photo-1295572.jpeg?auto=compress&cs=tinysrgb&w=600{% endif %}{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Product Images -->
            <div class="col-lg-6 mb-4">
                <div class="product-gallery">
                    <!-- Main Image -->
                    <div class="main-image mb-3">
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded-3 shadow-sm main-product-image" id="mainImage">
                        {% else %}
                            <img src="{% static 'images/placeholder.jpg' %}" alt="{{ product.name }}" class="img-fluid rounded-3 shadow-sm main-product-image" id="mainImage">
                        {% endif %}
                    </div>
                    
                    <!-- Thumbnail Images -->
                    {% if product.images.all %}
                    <div class="thumbnail-images d-flex flex-wrap gap-2">
                        {% for image in product.images.all %}
                        <div class="thumbnail-item">
                            <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}" class="img-thumbnail thumbnail-image" data-src="{{ image.image.url }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Product Details -->
            <div class="col-lg-6">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'core:shop' %}">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                    </ol>
                </nav>
                
                <h1 class="display-5 fw-bold mb-3">{{ product.name }}</h1>
                
                <!-- Rating -->
                {% if avg_rating > 0 %}
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <div class="testimonial-stars me-2">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= avg_rating|floatformat:"0"|add:"0" %}
                                    <i data-lucide="star" class="filled"></i>
                                {% else %}
                                    <i data-lucide="star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="text-muted">({{ reviews|length }} reviews)</span>
                    </div>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    {% if product.has_discount %}
                        <span class="h4 text-muted text-decoration-line-through me-2">${{ product.price }}</span>
                        <span class="h4 text-success fw-bold">${{ product.discounted_price|floatformat:2 }}</span>
                        <span class="badge bg-danger ms-2">{{ product.discount_percent }}% OFF</span>
                    {% else %}
                        <span class="h4 text-primary fw-bold">${{ product.price }}</span>
                    {% endif %}
                    
                    {% if product.in_stock %}
                        <span class="badge bg-success ms-2">In Stock</span>
                        {% if product.is_low_stock %}
                            <span class="badge bg-warning text-dark ms-2">Low Stock</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-danger ms-2">Out of Stock</span>
                    {% endif %}
                </div>
                
                <div class="mb-4">
                    <h5 class="fw-bold">Description</h5>
                    <p class="text-muted">{{ product.description }}</p>
                </div>
                
                <div class="mb-4">
                    <h5 class="fw-bold">Nutritional Information</h5>
                    <p class="text-muted">{{ product.nutritional_info|default:"Nutritional information not available." }}</p>
                </div>
                
                <div class="mb-4">
                    <h5 class="fw-bold">Category</h5>
                    <a href="{% url 'core:shop' %}?category={{ product.category.id }}" class="badge bg-secondary text-decoration-none">
                        {{ product.category.name }}
                    </a>
                </div>
                
                <!-- Tags -->
                {% if product.tags %}
                <div class="mb-4">
                    <h5 class="fw-bold">Tags</h5>
                    {% for tag in product.tags.split(',') %}
                    <span class="badge bg-info me-1">{{ tag|capfirst }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Gift Box Customizations -->
                {% if gift_box_customizations %}
                <div class="mb-4">
                    <h5 class="fw-bold">Customization Options</h5>
                    <div class="card">
                        <div class="card-body">
                            {% for customization in gift_box_customizations %}
                            <div class="form-check mb-2">
                                <input class="form-check-input gift-customization" 
                                       type="checkbox" 
                                       value="{{ customization.id }}" 
                                       id="customization{{ customization.id }}"
                                       data-price="{{ customization.price }}">
                                <label class="form-check-label" for="customization{{ customization.id }}">
                                    {{ customization.name }} 
                                    {% if customization.price > 0 %}
                                        <span class="text-muted">(+${{ customization.price }})</span>
                                    {% else %}
                                        <span class="text-muted">(Free)</span>
                                    {% endif %}
                                </label>
                                {% if customization.description %}
                                <small class="form-text text-muted d-block">{{ customization.description }}</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Gift Box Items -->
                {% if gift_box_items %}
                <div class="mb-4">
                    <h5 class="fw-bold">Items Included</h5>
                    <ul class="list-group">
                        {% for item in gift_box_items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-medium">{{ item.item.name }}</span>
                                <span class="text-muted">Ã— {{ item.quantity }}</span>
                            </div>
                            <span class="text-muted">${{ item.item.price }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Product Variants -->
                {% if product.variants.all %}
                <div class="mb-4">
                    <h5 class="fw-bold">Variants</h5>
                    <div class="d-flex flex-wrap gap-2">
                        {% for variant in product.variants.all %}
                            {% if variant.is_active and variant.in_stock %}
                                <button class="btn btn-outline-primary variant-btn" 
                                        data-variant-id="{{ variant.id }}"
                                        data-price="{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}">
                                    {{ variant.name }}: {{ variant.value }}
                                </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if product.in_stock %}
                <div class="mb-4">
                    <div class="input-group mb-3" style="max-width: 150px;">
                        <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
                        <input type="number" class="form-control text-center" value="1" min="1" max="{{ product.stock }}" id="quantityInput">
                        <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
                    </div>
                    <small class="text-muted">{{ product.stock }} items available</small>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button class="btn btn-primary btn-lg me-md-2 add-to-cart" data-product-id="{{ product.id }}">
                        <i data-lucide="shopping-cart" class="me-2"></i>Add to Cart
                    </button>
                    <button class="btn btn-outline-primary btn-lg wishlist-btn" data-product-id="{{ product.id }}">
                        <i data-lucide="heart" class="me-2"></i>Wishlist
                    </button>
                </div>
                
                <!-- Share Buttons -->
                <div class="mt-4">
                    <h5 class="fw-bold">Share this product</h5>
                    <div class="d-flex gap-2">
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="btn btn-outline-primary">
                            <i data-lucide="facebook"></i>
                        </a>
                        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ product.name }}" target="_blank" class="btn btn-outline-info">
                            <i data-lucide="twitter"></i>
                        </a>
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri }}&title={{ product.name }}" target="_blank" class="btn btn-outline-primary">
                            <i data-lucide="linkedin"></i>
                        </a>
                        <a href="mailto:?subject=Check out this product&body={{ request.build_absolute_uri }}" class="btn btn-outline-secondary">
                            <i data-lucide="mail"></i>
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i data-lucide="alert-triangle" class="me-2"></i>This product is currently out of stock.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Product Reviews -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Customer Reviews</h3>
                
                {% if reviews %}
                <div class="row g-4">
                    {% for review in reviews %}
                    <div class="col-lg-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1">{{ review.user.full_name }}</h5>
                                        <div class="testimonial-stars">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= review.rating %}
                                                    <i data-lucide="star" class="filled"></i>
                                                {% else %}
                                                    <i data-lucide="star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% if review.is_verified %}
                                        <span class="badge bg-success">Verified Purchase</span>
                                    {% endif %}
                                </div>
                                <p class="card-text">{{ review.comment }}</p>
                                <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-lucide="message-circle" class="text-muted" style="width: 48px; height: 48px;"></i>
                    <h5 class="mt-3">No reviews yet</h5>
                    <p class="text-muted">Be the first to review this product!</p>
                </div>
                {% endif %}
                
                <!-- Add Review Form -->
                {% if user.is_authenticated %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Write a Review</h5>
                    </div>
                    <div class="card-body">
                        <form id="review-form">
                            <div class="mb-3">
                                <label class="form-label">Rating</label>
                                <div class="rating-stars">
                                    <input type="hidden" id="rating-value" name="rating" value="0">
                                    {% for i in "12345" %}
                                    <i data-lucide="star" class="star-icon text-muted" data-rating="{{ forloop.counter }}" style="cursor: pointer; width: 24px; height: 24px;"></i>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="review-comment" class="form-label">Your Review</label>
                                <textarea class="form-control" id="review-comment" name="comment" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Related Products -->
        {% if related_products %}
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Related Products</h3>
                <div class="row g-4">
                    {% for product in related_products %}
                    <div class="col-lg-3 col-md-6">
                        <div class="product-card">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="card-img-top">
                            {% else %}
                                <img src="{% static 'images/placeholder.jpg' %}" alt="{{ product.name }}" class="card-img-top">
                            {% endif %}
                            <div class="product-card-body">
                                <h5 class="product-title">{{ product.name }}</h5>
                                <p class="product-description">{{ product.description|truncatewords:15 }}</p>
                                
                                <!-- Product Variants (Weight Options) -->
                                {% if product.variants.all %}
                                <div class="mb-2">
                                    <label class="form-label small">Weight:</label>
                                    <select class="form-select form-select-sm variant-select" data-product-id="{{ product.id }}">
                                        <option value="" data-price="{{ product.price }}" data-base-price="{{ product.price }}">Select Weight</option>
                                        {% for variant in product.variants.all %}
                                            {% if variant.is_active and variant.in_stock %}
                                                <option value="{{ variant.id }}" 
                                                        data-price="{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}" 
                                                        data-base-price="{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}"
                                                        data-stock="{{ variant.stock }}">
                                                    {{ variant.value }} - â‚¹{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                {% endif %}
                                
                                <!-- Quantity Selector -->
                                <div class="mb-2">
                                    <label class="form-label small">Quantity:</label>
                                    <div class="input-group input-group-sm" style="max-width: 120px;">
                                        <button class="btn btn-outline-secondary qty-btn" type="button" data-action="decrease">-</button>
                                        <input type="number" class="form-control text-center qty-input" value="1" min="1" max="{{ product.stock }}" data-product-id="{{ product.id }}" readonly>
                                        <button class="btn btn-outline-secondary qty-btn" type="button" data-action="increase">+</button>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    {% if product.has_discount and not product.variants.all %}
                                        <div>
                                            <span class="product-price text-decoration-line-through text-muted me-2">â‚¹{{ product.price }}</span>
                                            <span class="product-price text-success fw-bold discounted-price" data-product-id="{{ product.id }}" data-base-price="{{ product.discounted_price }}">â‚¹{{ product.discounted_price|floatformat:2 }}</span>
                                        </div>
                                    {% elif product.variants.all %}
                                        <span class="product-price" data-product-id="{{ product.id }}" data-base-price="{{ product.price }}">â‚¹{{ product.price }}</span>
                                    {% else %}
                                        <span class="product-price" data-product-id="{{ product.id }}" data-base-price="{{ product.price }}">â‚¹{{ product.price }}</span>
                                    {% endif %}
                                    {% if product.in_stock %}
                                        <button class="btn btn-primary btn-sm add-to-cart" data-product-id="{{ product.id }}">
                                            <i data-lucide="shopping-cart" class="me-1"></i>Add to Cart
                                        </button>
                                    {% else %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Upsell Products -->
        {% if upsell_products %}
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">You May Also Like</h3>
                <div class="row g-4">
                    {% for product in upsell_products %}
                    <div class="col-lg-3 col-md-6">
                        <div class="product-card">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="card-img-top">
                            {% else %}
                                <img src="{% static 'images/placeholder.jpg' %}" alt="{{ product.name }}" class="card-img-top">
                            {% endif %}
                            <div class="product-card-body">
                                <h5 class="product-title">{{ product.name }}</h5>
                                <p class="product-description">{{ product.description|truncatewords:15 }}</p>
                                
                                <!-- Product Variants (Weight Options) -->
                                {% if product.variants.all %}
                                <div class="mb-2">
                                    <label class="form-label small">Weight:</label>
                                    <select class="form-select form-select-sm variant-select" data-product-id="{{ product.id }}">
                                        <option value="" data-price="{{ product.price }}" data-base-price="{{ product.price }}">Select Weight</option>
                                        {% for variant in product.variants.all %}
                                            {% if variant.is_active and variant.in_stock %}
                                                <option value="{{ variant.id }}" 
                                                        data-price="{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}" 
                                                        data-base-price="{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}"
                                                        data-stock="{{ variant.stock }}">
                                                    {{ variant.value }} - â‚¹{% if variant.price > 0 %}{{ variant.price }}{% else %}{{ product.price }}{% endif %}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                {% endif %}
                                
                                <!-- Quantity Selector -->
                                <div class="mb-2">
                                    <label class="form-label small">Quantity:</label>
                                    <div class="input-group input-group-sm" style="max-width: 120px;">
                                        <button class="btn btn-outline-secondary qty-btn" type="button" data-action="decrease">-</button>
                                        <input type="number" class="form-control text-center qty-input" value="1" min="1" max="{{ product.stock }}" data-product-id="{{ product.id }}" readonly>
                                        <button class="btn btn-outline-secondary qty-btn" type="button" data-action="increase">+</button>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    {% if product.has_discount and not product.variants.all %}
                                        <div>
                                            <span class="product-price text-decoration-line-through text-muted me-2">â‚¹{{ product.price }}</span>
                                            <span class="product-price text-success fw-bold discounted-price" data-product-id="{{ product.id }}" data-base-price="{{ product.discounted_price }}">â‚¹{{ product.discounted_price|floatformat:2 }}</span>
                                        </div>
                                    {% elif product.variants.all %}
                                        <span class="product-price" data-product-id="{{ product.id }}" data-base-price="{{ product.price }}">â‚¹{{ product.price }}</span>
                                    {% else %}
                                        <span class="product-price" data-product-id="{{ product.id }}" data-base-price="{{ product.price }}">â‚¹{{ product.price }}</span>
                                    {% endif %}
                                    {% if product.in_stock %}
                                        <button class="btn btn-primary btn-sm add-to-cart" data-product-id="{{ product.id }}">
                                            <i data-lucide="shopping-cart" class="me-1"></i>Add to Cart
                                        </button>
                                    {% else %}
                                        <span class="badge bg-danger">Out of Stock</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Structured Data for Product -->
<script type="application/ld+json">
{
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": "{{ product.name }}",
    "image": [
        "{% if product.image %}{{ request.build_absolute_uri }}{{ product.image.url }}{% endif %}"
    ],
    "description": "{{ product.description|escapejs }}",
    "sku": "{{ product.id }}",
    "brand": {
        "@type": "Brand",
        "name": "NutriHarvest"
    },
    "offers": {
        "@type": "Offer",
        "url": "{{ request.build_absolute_uri }}",
        "priceCurrency": "USD",
        "price": "{{ product.discounted_price|floatformat:2 }}",
        "priceValidUntil": "{{ product.updated_at|date:'Y-m-d' }}",
        "itemCondition": "https://schema.org/NewCondition",
        "availability": "{% if product.in_stock %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
        "seller": {
            "@type": "Organization",
            "name": "NutriHarvest"
        }
    },
    "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ avg_rating|floatformat:1 }}",
        "reviewCount": "{{ reviews|length }}"
    }
}
</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quantity controls for main product
    const quantityInput = document.getElementById('quantityInput');
    const decreaseBtn = document.getElementById('decreaseQty');
    const increaseBtn = document.getElementById('increaseQty');
    
    if (quantityInput && decreaseBtn && increaseBtn) {
        decreaseBtn.addEventListener('click', function() {
            let value = parseInt(quantityInput.value);
            if (value > 1) {
                quantityInput.value = value - 1;
            }
        });
        
        increaseBtn.addEventListener('click', function() {
            let value = parseInt(quantityInput.value);
            let max = parseInt(quantityInput.max);
            if (value < max) {
                quantityInput.value = value + 1;
            }
        });
        
        quantityInput.addEventListener('change', function() {
            let value = parseInt(this.value);
            let max = parseInt(this.max);
            if (value < 1) this.value = 1;
            if (value > max) this.value = max;
        });
    }
    
    // Image gallery functionality
    const thumbnailImages = document.querySelectorAll('.thumbnail-image');
    const mainImage = document.getElementById('mainImage');
    
    thumbnailImages.forEach(thumb => {
        thumb.addEventListener('click', function() {
            const src = this.getAttribute('data-src');
            if (mainImage && src) {
                mainImage.src = src;
                // Update active state
                thumbnailImages.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });
    
    // Set first thumbnail as active
    if (thumbnailImages.length > 0) {
        thumbnailImages[0].classList.add('active');
    }
    
    // Variant selection
    const variantButtons = document.querySelectorAll('.variant-btn');
    const addToCartBtn = document.querySelector('.add-to-cart');
    
    variantButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            variantButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update price display if needed
            const price = this.getAttribute('data-price');
            if (price) {
                const priceElement = document.querySelector('.product-price');
                if (priceElement) {
                    priceElement.textContent = 'â‚¹' + price;
                }
            }
            
            // Update add to cart button with variant info
            if (addToCartBtn) {
                addToCartBtn.setAttribute('data-variant-id', this.getAttribute('data-variant-id'));
            }
        });
    });
    
    // Gift box customization
    const customizationCheckboxes = document.querySelectorAll('.gift-customization');
    const basePrice = parseFloat("{{ product.price }}");
    
    customizationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateTotalPrice();
        });
    });
    
    function updateTotalPrice() {
        let totalPrice = basePrice;
        
        customizationCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const price = parseFloat(checkbox.getAttribute('data-price')) || 0;
                totalPrice += price;
            }
        });
        
        // Update price display
        const priceElement = document.querySelector('.product-price');
        if (priceElement) {
            priceElement.textContent = 'â‚¹' + totalPrice.toFixed(2);
        }
    }
    
    // Wishlist functionality
    const wishlistBtn = document.querySelector('.wishlist-btn');
    if (wishlistBtn) {
        wishlistBtn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            
            fetch('{% url "orders:add_to_wishlist" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    product_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `
                        <strong>Success!</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Auto dismiss after 3 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 3000);
                } else {
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `
                        <strong>Error!</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Auto dismiss after 3 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }
    
    // Rating stars
    const starIcons = document.querySelectorAll('.star-icon[data-rating]');
    const ratingValue = document.getElementById('rating-value');
    
    starIcons.forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.getAttribute('data-rating');
            ratingValue.value = rating;
            
            // Update star appearance
            starIcons.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('filled');
                    s.classList.remove('text-muted');
                    s.classList.add('text-warning');
                } else {
                    s.classList.remove('filled');
                    s.classList.remove('text-warning');
                    s.classList.add('text-muted');
                }
            });
        });
        
        star.addEventListener('mouseenter', function() {
            const rating = this.getAttribute('data-rating');
            starIcons.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('text-warning');
                } else {
                    s.classList.remove('text-warning');
                }
            });
        });
    });
    
    // Reset star appearance on mouse leave
    document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
        const currentRating = parseInt(ratingValue.value);
        starIcons.forEach((s, index) => {
            if (index < currentRating) {
                s.classList.add('filled');
                s.classList.add('text-warning');
                s.classList.remove('text-muted');
            } else {
                s.classList.remove('filled');
                s.classList.remove('text-warning');
                s.classList.add('text-muted');
            }
        });
    });
    
    // Review form submission
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const rating = document.getElementById('rating-value').value;
            const comment = document.getElementById('review-comment').value;
            
            if (rating === '0') {
                alert('Please select a rating');
                return;
            }
            
            if (comment.trim() === '') {
                alert('Please enter your review');
                return;
            }
            
            fetch('{% url "shop:submit_review" product.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    rating: rating,
                    comment: comment
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert('Review submitted successfully!');
                    // Reset form
                    reviewForm.reset();
                    // Reset stars
                    ratingValue.value = '0';
                    starIcons.forEach(s => {
                        s.classList.remove('filled');
                        s.classList.remove('text-warning');
                        s.classList.add('text-muted');
                    });
                } else {
                    alert('Error submitting review: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting review. Please try again.');
            });
        });
    }
    
    // Quantity buttons functionality for related and upsell products
    const qtyButtons = document.querySelectorAll('.qty-btn');
    qtyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const input = this.parentNode.querySelector('.qty-input');
            const productId = input.getAttribute('data-product-id');
            let value = parseInt(input.value);
            const max = parseInt(input.max) || 999;
            
            if (action === 'increase' && value < max) {
                value++;
            } else if (action === 'decrease' && value > 1) {
                value--;
            }
            
            input.value = value;
            updateProductPrice(productId, value);
        });
    });
    
    // Variant selection functionality for related and upsell products
    const variantSelects = document.querySelectorAll('.variant-select');
    variantSelects.forEach(select => {
        select.addEventListener('change', function() {
            const productId = this.getAttribute('data-product-id');
            const selectedOption = this.options[this.selectedIndex];
            const basePrice = parseFloat(selectedOption.getAttribute('data-base-price'));
            const stock = parseInt(selectedOption.getAttribute('data-stock')) || 999;
            
            // Update the price display
            const priceElements = document.querySelectorAll(`[data-product-id="${productId}"]`);
            priceElements.forEach(element => {
                element.setAttribute('data-base-price', basePrice);
                element.textContent = 'â‚¹' + basePrice.toFixed(2);
            });
            
            // Update the quantity input max value
            const qtyInput = document.querySelector(`.qty-input[data-product-id="${productId}"]`);
            if (qtyInput) {
                qtyInput.max = stock;
                // Reset quantity to 1 if it exceeds the new max
                if (parseInt(qtyInput.value) > stock) {
                    qtyInput.value = 1;
                }
            }
            
            // Update the price based on quantity
            const quantity = parseInt(qtyInput.value) || 1;
            updateProductPrice(productId, quantity);
        });
    });
    
    // Function to update product price based on quantity
    function updateProductPrice(productId, quantity) {
        // Find all price elements for this product
        const priceElements = document.querySelectorAll(`[data-product-id="${productId}"]`);
        
        priceElements.forEach(element => {
            // Get the base price from data attribute
            const basePrice = parseFloat(element.getAttribute('data-base-price'));
            
            if (!isNaN(basePrice)) {
                const totalPrice = basePrice * quantity;
                
                // Update the displayed price
                if (element.classList.contains('discounted-price')) {
                    element.textContent = 'â‚¹' + totalPrice.toFixed(2);
                } else {
                    element.textContent = 'â‚¹' + totalPrice.toFixed(2);
                }
            }
        });
    }
    
    // Initialize Lucide icons
    lucide.createIcons();
});
</script>
{% endblock %}