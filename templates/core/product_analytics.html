{% extends 'base.html' %}
{% load static %}

{% block title %}Product Analytics - NutriHarvest{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-4 fw-bold mb-0">Product Analytics</h1>
                <a href="{% url 'core:admin_panel' %}" class="btn btn-outline-primary">
                    <i data-lucide="arrow-left" class="me-2"></i>Back to Dashboard
                </a>
            </div>
            <p class="lead mb-4">Detailed insights into product performance, sales trends, and customer behavior.</p>
            
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Date Range Filter -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="days" class="form-label">Time Period</label>
                            <select class="form-select" id="days" name="days">
                                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 Days</option>
                                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 Days</option>
                                <option value="365" {% if days == 365 %}selected{% endif %}>Last Year</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary">
                                <i data-lucide="refresh-cw" class="me-2"></i>Update
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Key Metrics -->
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="text-muted">Total Products</h5>
                                    <h2 class="fw-bold text-primary">{{ inventory_stats.total_products }}</h2>
                                </div>
                                <div class="stat-icon products">
                                    <i data-lucide="package"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="text-muted">Out of Stock</h5>
                                    <h2 class="fw-bold text-danger">{{ inventory_stats.out_of_stock }}</h2>
                                </div>
                                <div class="stat-icon warning">
                                    <i data-lucide="alert-triangle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="text-muted">Low Stock</h5>
                                    <h2 class="fw-bold text-warning">{{ inventory_stats.low_stock }}</h2>
                                </div>
                                <div class="stat-icon warning">
                                    <i data-lucide="alert-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="text-muted">Avg Rating</h5>
                                    <h2 class="fw-bold text-success">{{ review_stats.avg_rating|floatformat:1 }}</h2>
                                </div>
                                <div class="stat-icon rating">
                                    <i data-lucide="star"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sales Trends Chart -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Sales Trends</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="salesChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row g-4">
                <!-- Top Selling Products -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Top Selling Products</h5>
                        </div>
                        <div class="card-body">
                            {% if top_selling_products %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Category</th>
                                            <th>Units Sold</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for product in top_selling_products %}
                                        <tr>
                                            <td>{{ product.name }}</td>
                                            <td>{{ product.category.name }}</td>
                                            <td>{{ product.total_sold|default:0 }}</td>
                                            <td>${{ product.total_revenue|default:0|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">No sales data available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Category Performance -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Category Performance</h5>
                        </div>
                        <div class="card-body">
                            {% if category_performance %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Products</th>
                                            <th>Units Sold</th>
                                            <th>Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in category_performance %}
                                        <tr>
                                            <td>{{ category.name }}</td>
                                            <td>{{ category.total_products }}</td>
                                            <td>{{ category.total_sold|default:0 }}</td>
                                            <td>${{ category.total_revenue|default:0|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted">No category performance data available.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory and Review Analytics -->
            <div class="row g-4 mt-4">
                <!-- Inventory Status -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Inventory Status</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="inventoryChart" height="100"></canvas>
                            <div class="mt-3">
                                <div class="d-flex justify-content-around text-center">
                                    <div>
                                        <h4 class="text-danger">{{ inventory_stats.out_of_stock }}</h4>
                                        <p class="text-muted mb-0">Out of Stock</p>
                                    </div>
                                    <div>
                                        <h4 class="text-warning">{{ inventory_stats.low_stock }}</h4>
                                        <p class="text-muted mb-0">Low Stock</p>
                                    </div>
                                    <div>
                                        <h4 class="text-success">{{ inventory_stats.well_stocked }}</h4>
                                        <p class="text-muted mb-0">Well Stocked</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Review Analytics -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Review Analytics</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="ratingChart" height="100"></canvas>
                            <div class="mt-3">
                                <div class="d-flex justify-content-around text-center">
                                    <div>
                                        <h4 class="text-primary">{{ review_stats.total_reviews }}</h4>
                                        <p class="text-muted mb-0">Total Reviews</p>
                                    </div>
                                    <div>
                                        <h4 class="text-success">{{ review_stats.approved_reviews }}</h4>
                                        <p class="text-muted mb-0">Approved</p>
                                    </div>
                                    <div>
                                        <h4 class="text-warning">{{ review_stats.pending_reviews }}</h4>
                                        <p class="text-muted mb-0">Pending</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Sales Chart
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    const salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: [
                {% for item in sales_over_time %}
                    '{{ item.day|date:"M d" }}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Units Sold',
                data: [
                    {% for item in sales_over_time %}
                        {{ item.total_quantity|default:0 }},
                    {% endfor %}
                ],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.1
            }, {
                label: 'Revenue',
                data: [
                    {% for item in sales_over_time %}
                        {{ item.total_revenue|default:0 }},
                    {% endfor %}
                ],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    beginAtZero: true,
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
    
    // Inventory Chart
    const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
    const inventoryChart = new Chart(inventoryCtx, {
        type: 'doughnut',
        data: {
            labels: ['Out of Stock', 'Low Stock', 'Well Stocked'],
            datasets: [{
                data: [
                    {{ inventory_stats.out_of_stock }},
                    {{ inventory_stats.low_stock }},
                    {{ inventory_stats.well_stocked }}
                ],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
    
    // Rating Chart
    const ratingCtx = document.getElementById('ratingChart').getContext('2d');
    const ratingChart = new Chart(ratingCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for item in rating_distribution %}
                    '{{ item.rating }} Star{% if item.rating > 1 %}s{% endif %}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Number of Reviews',
                data: [
                    {% for item in rating_distribution %}
                        {{ item.count|default:0 }},
                    {% endfor %}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 205, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(54, 162, 235, 0.2)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}